# Cross-Account Communication Setup Guide

This guide outlines the steps to enable cross-account communication between an EC2 instance in Account "B" and an Amazon Kinesis Data Firehose in Account "A". By following these instructions, you'll establish secure access using IAM roles and policies.

## Table of Contents
1. [Create an IAM Role in Account "A"](##Create-IAM-Role-in-Account-A)
2. [Update Trust Relationship for the Role](##Update-Trust-Relationship-for-the-Role)
3. [Retrieve the Role ARN](##Retrieve-the-Role-ARN)
4. [Create an IAM Policy in Account "B"](##Create-IAM-Policy-in-Account-B)
5. [Attach the IAM Policy to an IAM User/Role in Account "B"](##Attach-IAM-Policy-to-IAM-User/Role-in-Account-B)
6. [Implement STS to Assume Role in Code](##Implement-STS-to-Assume-Role-in-Code)

## 1. Create an IAM Role in Account "A"
- Go to the IAM console in Account "A".
- Click on "Roles" in the left-hand navigation pane.
- Select "Create role".
- Choose "Another AWS account" as the trusted entity.
- Enter the Account ID of Account "B".
- Enable the option to Require external ID.
- Enter the External ID, which is a unique identifier agreed upon between Account "A" and Account "B".
- Attach the "AmazonKinesisFirehoseFullAccess" policy (or a custom policy with necessary permissions) to this role.

## 2. Update Trust Relationship for the Role
- After creating the role, select the role you just created.
- Under the "Trust relationships" tab, click "Edit trust relationship".
- Update the trust policy document to include Account "B" as a trusted entity along with the External ID. The trust policy should resemble the provided JSON structure.
```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "AWS": "arn:aws:iam::ACCOUNT_B_ID:role/ROLE_NAME_IN_B"
          },
          "Action": "sts:AssumeRole",
          "Condition": {
            "StringEquals": {
              "sts:ExternalId": "YOUR_EXTERNAL_ID"
            }
          }
        }
      ]
    }
```
Replace "ACCOUNT_B_ID" with the actual Account "B" ID, "ROLE_NAME_IN_B" with the name of the IAM role in Account "B", and "YOUR_EXTERNAL_ID" with the agreed-upon external ID.
## 3. Retrieve the Role ARN
- Once the role is created, make a note of the Role ARN. You will need it in Account "B".

## 4. Create an IAM Policy in Account "B"
- Proceed to the IAM console in Account "B".
- Click on "Policies" in the left-hand navigation pane.
- Select "Create policy".
- Choose the JSON tab and enter a policy document similar to the provided JSON structure.
```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": "sts:AssumeRole",
          "Resource": "arn:aws:iam::ACCOUNT_A_ID:role/ROLE_NAME"
        }
      ]
    }
```
Replace "ACCOUNT_A_ID" with the actual Account "A" ID and "ROLE_NAME" with the name of the role created in Account "A".

## 5. Attach the IAM Policy to an IAM User/Role in Account "B"
### 5.1. Attach the IAM Policy to an IAM User in Account "B"
- Go to the IAM console in Account "B".
- Click on "Users" in the left-hand navigation pane if you want to attach the policy to an existing user, or click on "Add user" to create a new IAM user if needed.
- Select the IAM user to which you want to attach the policy, or create a new user and make note of the user's username.
- Under the "Permissions" tab, click on "Add permissions".
- Choose "Attach existing policies directly".
- Search for the IAM policy you created earlier (the one allowing AssumeRole) and select it.
- Click "Next: Review" and then "Add permissions" to attach the policy to the IAM user.

### 5.2. Attach the IAM Policy to an IAM Role in Account "B"
- Go to the IAM console in Account "B".
- Click on "Roles" in the left-hand navigation pane if you want to attach the policy to an existing role, or click on "Create role" to create a new IAM role if needed.
- Select the IAM role to which you want to attach the policy, or create a new role and make note of the role's name.
- Under the "Permissions" tab, click on "Add inline policies" or "Attach policies".
- Choose "Attach policies" if you want to attach an existing policy.
- Search for the IAM policy you created earlier (the one allowing AssumeRole) and select it.
- Click "Next: Review" and then "Add permissions" to attach the policy to the IAM role.

## 6. Implement STS to Assume Role in Code
- Within your EC2 instance in Account "B", utilize the AWS SDK to assume the IAM role created in Account "A" using STS.
- After assuming the role, you will receive temporary credentials to make requests to Amazon Kinesis Data Firehose.

Ensure to replace placeholders like ACCOUNT_A_ID, ACCOUNT_B_ID, ROLE_NAME_IN_B, and YOUR_EXTERNAL_ID with actual values specific to your AWS accounts and resources.
